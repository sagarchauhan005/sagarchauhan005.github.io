# CI/CD Pipeline for deploying to GCP VM
# This workflow runs only on the 'new-website' branch
# Note: Nginx configuration is already set up on the VM
#
# Required GitHub Secrets:
#   GCP_SA_KEY: JSON service account key for GCP authentication
#   GCP_PROJECT_ID: Your GCP project ID
#   GCP_INSTANCE_NAME: Name of the VM instance
#   GCP_INSTANCE_ZONE: Zone where the VM is located (e.g., us-central1-a)
#   GCP_WEB_ROOT: (Optional) Web root directory on VM (defaults to /opt/sagarchauhan.in)

name: Deploy to GCP VM

on:
  push:
    branches:
      - new-website
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Prepare deployment files
        run: |
          # Create temporary directory
          TEMP_DIR=$(mktemp -d)
          echo "TEMP_DIR=$TEMP_DIR" >> $GITHUB_ENV
          
          # Copy website files (excluding unnecessary files)
          rsync -av --exclude='.git' \
                    --exclude='node_modules' \
                    --exclude='.DS_Store' \
                    --exclude='*.zip' \
                    --exclude='deploy.sh' \
                    --exclude='setup-ssl.sh' \
                    --exclude='README.md' \
                    --exclude='readme.md' \
                    --exclude='.github' \
                    ./ "$TEMP_DIR/"

      - name: Create deployment archive
        run: |
          cd "$TEMP_DIR"
          ARCHIVE_NAME="website-deploy-$(date +%Y%m%d-%H%M%S).tar.gz"
          tar -czf "../$ARCHIVE_NAME" .
          cd - > /dev/null
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV
          mv "$TEMP_DIR/../$ARCHIVE_NAME" ./deploy-archive.tar.gz

      - name: Upload files to VM
        run: |
          gcloud compute scp ./deploy-archive.tar.gz \
            ${{ secrets.GCP_INSTANCE_NAME }}:deploy-archive.tar.gz \
            --zone=${{ secrets.GCP_INSTANCE_ZONE }}

      - name: Deploy on VM
        env:
          WEB_ROOT: ${{ secrets.GCP_WEB_ROOT || '/opt/sagarchauhan.in' }}
        run: |
          gcloud compute ssh ${{ secrets.GCP_INSTANCE_NAME }} \
            --zone=${{ secrets.GCP_INSTANCE_ZONE }} \
            --command="
              set -e
              WEB_ROOT=\"$WEB_ROOT\"
              echo 'Extracting files to '\$WEB_ROOT'...'
              sudo mkdir -p \$WEB_ROOT
              sudo tar -xzf deploy-archive.tar.gz -C \$WEB_ROOT
              sudo chown -R www-data:www-data \$WEB_ROOT
              sudo chmod -R 755 \$WEB_ROOT
              
              echo 'Cleaning up...'
              rm -f deploy-archive.tar.gz
              echo 'Deployment completed successfully!'
            "

      - name: Cleanup
        if: always()
        run: |
          rm -f ./deploy-archive.tar.gz
          if [ -n "$TEMP_DIR" ]; then
            rm -rf "$TEMP_DIR"
          fi

